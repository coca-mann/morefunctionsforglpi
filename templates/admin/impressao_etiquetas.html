{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    /* Cores padrão do Admin */
    :root {
      --custom-module-bg: var(--body-bg, #f0f0f0);
      --custom-body-bg: var(--body-bg, #f9f9f9);
      --custom-border-color: var(--border-color, #ccc);
      --custom-error-fg: var(--error-fg, #ba2121);
      --custom-success-fg: var(--success-fg, #41763b);
      --custom-header-link-color: var(--header-link-color, #3498db);
    }
  
    .asset-filters button {
      margin-right: 5px;
      margin-bottom: 10px;
      
      opacity: 0.7;
      border-width: 2px;
      border-color: transparent; 
      transition: opacity 0.2s ease, border-color 0.2s ease;
    }

    .asset-filters button.active {
      opacity: 1;
      border-color: var(--custom-header-link-color); 
    }
    
    .controls-bar {
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 10px;
      background: var(--custom-module-bg); 
      padding: 10px;
      border-radius: 4px;
      gap: 15px;
    }

    .search-wrapper {
      flex-grow: 1;
      text-align: center;
    }

    #search-input {
      width: 60%;
      padding: 8px 10px;
      border: 1px solid var(--custom-border-color);
      border-radius: 4px;
      background-color: var(--custom-body-bg); 
      color: var(--body-fg); 
      box-sizing: border-box;
    }
    
    .table-container {
      max-height: 50vh;
      overflow-y: auto;
      border: 1px solid var(--custom-border-color);
      border-radius: 4px;
      background: var(--custom-body-bg);
    }
    
    #results-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    #results-table th, #results-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--custom-border-color);
    }
    
    #results-table th {
      background: var(--custom-module-bg);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    
    #results-table th[data-key] {
      cursor: pointer;
      user-select: none;
    }

    #results-table th[data-key]::after {
      content: ' \25B2\25BC';
      color: var(--custom-border-color);
      opacity: 0.5;
    }
    #results-table th[data-sort-dir="asc"]::after {
      content: ' \25B2';
      opacity: 1;
      color: var(--custom-header-link-color);
    }
    #results-table th[data-sort-dir="desc"]::after {
      content: ' \25BC';
      opacity: 1;
      color: var(--custom-header-link-color);
    }
    
    .loader {
      display: none;
      border: 4px solid var(--custom-module-bg);
      border-radius: 50%;
      border-top: 4px solid var(--custom-header-link-color);
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    
    #print-message {
      margin-top: 10px;
      font-weight: bold;
    }
    #print-message.success { color: var(--custom-success-fg); }
    #print-message.error { color: var(--custom-error-fg); }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
{% endblock %}

{% block content %}

<p>Selecione um tipo de ativo para carregar os itens. Em seguida, selecione os itens que deseja imprimir.</p>

<div class="asset-filters">
  {% for asset_value, asset_name in tipos_de_ativos_display %}
    <button class="button" data-type="{{ asset_value }}">
      {{ asset_name }}
    </button>
  {% endfor %}
</div>

<hr>

<div class="controls-bar">
  <button id="print-button" class="button" disabled>Imprimir Selecionados</button>
  
  <div id="layout-container" style="display: flex; align-items: center; gap: 5px;">
      <label for="layout-select" style="font-weight: bold; color: var(--body-fg);">Layout:</label>
      <select id="layout-select" name="layout" class="select">
          <option value="">Carregando layouts...</option>
      </select>
  </div>
  
  <div class="search-wrapper">
    <input type="search" id="search-input" placeholder="Filtrar por nome do ativo...">
  </div>
  
  <div class="loader" id="loader"></div>
  
  <div>
    <input type="checkbox" id="select-all" style="margin-right: 5px;">
    <label for="select-all">Marcar/Desmarcar Todos</label>
  </div>
</div>
<div class="table-container">
  <table id="results-table">
    <thead>
      <tr>
        <th style="width: 20px;"></th>
        <th data-key="asset_name">Nome do Ativo</th>
        <th data-key="entity">Entidade</th>
        <th data-key="asset_type">Tipo</th>
      </tr>
    </thead>
    <tbody id="results-body">
      <tr>
        <td colspan="4" style="text-align: center; padding: 20px;">
          Selecione um tipo de ativo acima.
        </td>
      </tr>
    </tbody>
  </table>
</div>

<div id="print-message"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // --- Referências aos elementos ---
    const filterButtons = document.querySelectorAll('.asset-filters button');
    const printButton = document.getElementById('print-button');
    const selectAllCheckbox = document.getElementById('select-all');
    const loader = document.getElementById('loader');
    const printMessage = document.getElementById('print-message');
    const resultsBody = document.getElementById('results-body');
    const headers = document.querySelectorAll('#results-table th[data-key]');
    const searchInput = document.getElementById('search-input');
    const layoutSelect = document.getElementById('layout-select');
    const layoutContainer = document.getElementById('layout-container');

    // --- URLs ---
    const dataApiUrl = "/api/get-assets/";
    const printApiUrl = '/api/imprimir/';
    const layoutsApiUrl = '/api/layouts/';

    // --- Variáveis de Estado ---
    let fetchedAssets = [];
    let currentSort = { key: 'asset_name', dir: 'asc' };

    // --- Inicialização ---
    fetchLayouts();

    // --- Funções ---
    function getCsrfToken() {
        return document.cookie.split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
    }

    async function fetchLayouts() {
        try {
            const response = await fetch(layoutsApiUrl);
            if (!response.ok) throw new Error(`Falha ao buscar layouts (status: ${response.status})`);
            const layouts = await response.json();

            if (layouts.length > 0) {
                layoutSelect.innerHTML = ''; // Limpa "Carregando..."
                layouts.forEach(layout => {
                    const option = document.createElement('option');
                    option.value = layout.id;
                    option.textContent = layout.nome;
                    if (layout.padrao) {
                        option.selected = true;
                    }
                    layoutSelect.appendChild(option);
                });
            } else {
                layoutSelect.innerHTML = '<option value="">Nenhum layout encontrado</option>';
            }
        } catch (error) {
            console.error('Erro ao buscar layouts:', error);
            layoutSelect.innerHTML = '<option value="">Erro ao carregar</option>';
        }
    }

    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            const assetType = button.dataset.type;
            fetchAssets(assetType);
        });
    });

    async function fetchAssets(assetType) {
        resultsBody.innerHTML = ''; 
        printButton.disabled = true;
        selectAllCheckbox.checked = false;
        loader.style.display = 'block';
        printMessage.innerText = '';
        searchInput.value = ''; 
        fetchedAssets = [];

        try {
            const response = await fetch(`${dataApiUrl}?type=${assetType}`);
            if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);
            
            const assets = await response.json();
            fetchedAssets = assets;
            applyFiltersAndSort(); 

        } catch (error) {
            fetchedAssets = [];
            applyFiltersAndSort();
            console.error(error);
        } finally {
            loader.style.display = 'none';
        }
    }

    headers.forEach(header => {
        header.addEventListener('click', () => {
            const key = header.dataset.key;
            let newDir = 'asc';
            
            if (currentSort.key === key && currentSort.dir === 'asc') {
                newDir = 'desc';
            }
            
            currentSort = { key: key, dir: newDir };
            applyFiltersAndSort();
        });
    });

    searchInput.addEventListener('input', () => {
        applyFiltersAndSort();
    });

    function applyFiltersAndSort() {
        const searchTerm = searchInput.value.toLowerCase();
        let processedAssets = fetchedAssets;

        if (searchTerm) {
            processedAssets = fetchedAssets.filter(asset => 
                asset.asset_name.toLowerCase().includes(searchTerm)
            );
        }

        const { key, dir } = currentSort;
        const sortedAssets = [...processedAssets].sort((a, b) => {
            let valA = a[key] ? a[key].toString().toLowerCase() : '';
            let valB = b[key] ? b[key].toString().toLowerCase() : '';
            const numA = parseFloat(valA);
            const numB = parseFloat(valB);
            
            if (!isNaN(numA) && !isNaN(numB)) {
                valA = numA;
                valB = numB;
            }

            if (valA < valB) return dir === 'asc' ? -1 : 1;
            if (valA > valB) return dir === 'asc' ? 1 : -1;
            return 0;
        });

        headers.forEach(h => {
            if (h.dataset.key === key) h.dataset.sortDir = dir;
            else h.dataset.sortDir = '';
        });

        renderTable(sortedAssets);
    }

    function renderTable(assetsToRender) {
        resultsBody.innerHTML = '';
        
        if (assetsToRender.length === 0) {
            const searchTerm = searchInput.value;
            let message = 'Nenhum item encontrado para este tipo de ativo.';
            if (searchTerm) {
                message = `Nenhum item corresponde ao filtro "<b>${searchTerm}</b>".`;
            }
            resultsBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 20px;">${message}</td></tr>`;
            return;
        }
        
        assetsToRender.forEach(asset => {
            const tr = document.createElement('tr');
            tr.dataset.titulo = asset.asset_name; 
            tr.dataset.url = asset.url;

            tr.innerHTML = `
                <td><input type="checkbox" class="asset-checkbox"></td>
                <td>${asset.asset_name}</td>
                <td>${asset.entity}</td>
                <td>${asset.asset_type}</td>
            `;
            resultsBody.appendChild(tr);
        });
    }

    selectAllCheckbox.addEventListener('change', () => {
        const checkboxes = resultsBody.querySelectorAll('.asset-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = selectAllCheckbox.checked;
        });
        updatePrintButtonState();
    });

    printButton.addEventListener('click', () => {
        sendToPrintAPI();
    });

    async function sendToPrintAPI() {
        const selectedItems = [];
        const checkedCheckboxes = resultsBody.querySelectorAll('.asset-checkbox:checked');
        const layoutId = layoutSelect.value;

        checkedCheckboxes.forEach(cb => {
            const tr = cb.closest('tr');
            selectedItems.push({
                titulo: tr.dataset.titulo,
                url: tr.dataset.url
            });
        });

        if (selectedItems.length === 0) {
            alert('Selecione pelo menos um item para imprimir.');
            return;
        }

        printButton.disabled = true;
        printButton.innerText = 'Enviando...';
        printMessage.innerText = '';
        printMessage.className = '';

        try {
            const response = await fetch(printApiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    items: selectedItems,
                    layout_id: layoutId
                })
            });
            const result = await response.json();

            if (response.ok) {
                printMessage.className = 'success';
                printMessage.innerText = `Sucesso! ${result.mensagem || 'Itens enviados.'}`;
                checkedCheckboxes.forEach(cb => cb.checked = false);
                selectAllCheckbox.checked = false;
                updatePrintButtonState();
            } else {
                throw new Error(result.mensagem || 'Erro desconhecido no endpoint de impressão');
            }

        } catch (error) {
            printMessage.className = 'error';
            printMessage.innerText = `Erro ao imprimir: ${error.message}`;
        } finally {
            printButton.disabled = false;
            printButton.innerText = 'Imprimir Selecionados';
        }
    }

    resultsBody.addEventListener('change', (event) => {
        if (event.target.classList.contains('asset-checkbox')) {
            updatePrintButtonState();
        }
    });

    function updatePrintButtonState() {
        const anyChecked = resultsBody.querySelector('.asset-checkbox:checked');
        printButton.disabled = !anyChecked;
    }
});
</script>
{% endblock %}