{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    /* Cores padrão do Admin */
    :root {
      --custom-module-bg: var(--body-bg, #f0f0f0);
      --custom-body-bg: var(--body-bg, #f9f9f9);
      --custom-border-color: var(--border-color, #ccc);
      --custom-error-fg: var(--error-fg, #ba2121);
      --custom-success-fg: var(--success-fg, #41763b);
      --custom-header-link-color: var(--header-link-color, #3498db);
    }
  
    .asset-filters button {
      margin-right: 5px;
      margin-bottom: 10px;
    }
    
    .controls-bar {
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 10px;
      background: var(--custom-module-bg); 
      padding: 10px;
      border-radius: 4px;
    }

    /* ---- NOVOS ESTILOS PARA A TABELA ---- */
    .table-container {
      max-height: 50vh;
      overflow-y: auto;
      border: 1px solid var(--custom-border-color);
      border-radius: 4px;
      background: var(--custom-body-bg);
    }
    
    #results-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    #results-table th, #results-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--custom-border-color);
    }
    
    #results-table th {
      background: var(--custom-module-bg);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    
    /* Estilo para cabeçalhos clicáveis */
    #results-table th[data-key] {
      cursor: pointer;
      user-select: none;
    }

    /* Setas de Ordenação */
    #results-table th[data-key]::after {
      content: ' \25B2\25BC'; /* Símbolos de seta para cima e para baixo */
      color: var(--custom-border-color);
      opacity: 0.5;
    }
    #results-table th[data-sort-dir="asc"]::after {
      content: ' \25B2'; /* Seta para cima */
      opacity: 1;
      color: var(--custom-header-link-color);
    }
    #results-table th[data-sort-dir="desc"]::after {
      content: ' \25BC'; /* Seta para baixo */
      opacity: 1;
      color: var(--custom-header-link-color);
    }
    /* ---- FIM DOS ESTILOS DA TABELA ---- */
    
    .loader {
      display: none;
      border: 4px solid var(--custom-module-bg);
      border-radius: 50%;
      border-top: 4px solid var(--custom-header-link-color);
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    
    #print-message {
      margin-top: 10px;
      font-weight: bold;
    }
    #print-message.success { color: var(--custom-success-fg); }
    #print-message.error { color: var(--custom-error-fg); }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
{% endblock %}

{% block content %}

<p>Selecione um tipo de ativo para carregar os itens. Em seguida, selecione os itens que deseja imprimir.</p>

<div class="asset-filters">
  {% for asset_value, asset_name in tipos_de_ativos_display %}
    <button class="button" data-type="{{ asset_value }}">
      {{ asset_name }}
    </button>
  {% endfor %}
</div>

<hr>

<div class="controls-bar">
  <button id="print-button" class="button" disabled>Imprimir Selecionados</button>
  <div class="loader" id="loader"></div>
  <div>
    <input type="checkbox" id="select-all" style="margin-right: 5px;">
    <label for="select-all">Marcar/Desmarcar Todos</label>
  </div>
</div>

<div class="table-container">
  <table id="results-table">
    <thead>
      <tr>
        <th style="width: 20px;"></th>
        
        <th data-key="asset_name">Nome do Ativo</th>
        <th data-key="entity">Entidade / Local</th>
        <th data-key="asset_type">Tipo</th>
        
        </tr>
    </thead>
    <tbody id="results-body">
      <tr>
        <td colspan="4" style="text-align: center; padding: 20px;">
          Selecione um tipo de ativo acima.
        </td>
      </tr>
    </tbody>
  </table>
</div>
<div id="print-message"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // --- Referências aos elementos ---
    const filterButtons = document.querySelectorAll('.asset-filters button');
    const printButton = document.getElementById('print-button');
    const selectAllCheckbox = document.getElementById('select-all');
    const loader = document.getElementById('loader');
    const printMessage = document.getElementById('print-message');
    const resultsBody = document.getElementById('results-body'); // Agora é o <tbody>
    const headers = document.querySelectorAll('#results-table th[data-key]'); // Cabeçalhos ordenáveis
    
    // --- URLs ---
    const dataApiUrl = "/api/get-assets/";
    const printApiUrl = '/api/imprimir/'; 

    // --- Variáveis de Estado ---
    let fetchedAssets = []; // Armazena os dados brutos da API
    let currentSort = { key: 'asset_name', dir: 'asc' }; // Ordenação inicial

    // --- Função para buscar o Token CSRF ---
    function getCsrfToken() {
        return document.cookie.split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
    }

    // --- 1. Ação dos Botões de Filtro ---
    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            const assetType = button.dataset.type;
            fetchAssets(assetType);
        });
    });

    async function fetchAssets(assetType) {
        resultsBody.innerHTML = ''; // Limpa a tabela
        printButton.disabled = true;
        selectAllCheckbox.checked = false;
        loader.style.display = 'block';
        printMessage.innerText = '';
        fetchedAssets = []; // Limpa dados antigos

        try {
            const response = await fetch(`${dataApiUrl}?type=${assetType}`);
            if (!response.ok) {
                throw new Error(`Erro na API: ${response.statusText}`);
            }
            const assets = await response.json();
            
            if (assets.length === 0) {
                resultsBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">Nenhum item encontrado.</td></tr>';
                return;
            }

            fetchedAssets = assets; // Salva os dados brutos
            sortAndRender(); // Ordena e renderiza a tabela

        } catch (error) {
            resultsBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--custom-error-fg); padding: 20px;">Erro ao carregar dados: ${error.message}</td></tr>`;
            console.error(error);
        } finally {
            loader.style.display = 'none';
        }
    }

    // --- 2. Lógica de Ordenação ---
    
    // Adiciona o 'click' em cada cabeçalho
    headers.forEach(header => {
        header.addEventListener('click', () => {
            const key = header.dataset.key;
            let newDir = 'asc';
            
            // Se já estava ordenando por esta coluna, inverte a direção
            if (currentSort.key === key && currentSort.dir === 'asc') {
                newDir = 'desc';
            }
            
            currentSort = { key: key, dir: newDir };
            sortAndRender(); // Re-ordena e re-renderiza
        });
    });

    function sortAndRender() {
        const { key, dir } = currentSort;

        // Ordena a lista de ativos
        const sortedAssets = [...fetchedAssets].sort((a, b) => {
            let valA = a[key] ? a[key].toString().toLowerCase() : '';
            let valB = b[key] ? b[key].toString().toLowerCase() : '';

            // Tenta ordenar numericamente se parecer um número (ex: ID)
            const numA = parseFloat(valA);
            const numB = parseFloat(valB);
            
            if (!isNaN(numA) && !isNaN(numB)) {
                valA = numA;
                valB = numB;
            }

            // Lógica de comparação
            if (valA < valB) {
                return dir === 'asc' ? -1 : 1;
            }
            if (valA > valB) {
                return dir === 'asc' ? 1 : -1;
            }
            return 0; // são iguais
        });

        // Atualiza os indicadores visuais nos cabeçalhos
        headers.forEach(h => {
            if (h.dataset.key === key) {
                h.dataset.sortDir = dir;
            } else {
                h.dataset.sortDir = ''; // Limpa outros
            }
        });

        renderTable(sortedAssets); // Renderiza a tabela com os dados ordenados
    }

    // --- 3. Lógica de Renderização da Tabela ---
    function renderTable(assetsToRender) {
        resultsBody.innerHTML = ''; // Limpa a tabela
        
        assetsToRender.forEach(asset => {
            const tr = document.createElement('tr');
            
            // Armazena os dados para impressão no próprio <tr>
            // A API de impressão espera 'titulo' e 'url'
            tr.dataset.titulo = asset.asset_name; 
            tr.dataset.url = asset.url;

            // Coluna 1: Checkbox
            const tdCheck = document.createElement('td');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'asset-checkbox';
            tdCheck.appendChild(checkbox);
            tr.appendChild(tdCheck);

            // Coluna 2: Nome do Ativo
            const tdName = document.createElement('td');
            tdName.textContent = asset.asset_name;
            tr.appendChild(tdName);

            // Coluna 3: Entidade
            const tdEntity = document.createElement('td');
            tdEntity.textContent = asset.entity;
            tr.appendChild(tdEntity);

            // Coluna 4: Tipo de Ativo
            const tdType = document.createElement('td');
            tdType.textContent = asset.asset_type;
            tr.appendChild(tdType);

            resultsBody.appendChild(tr);
        });
    }

    // --- 4. Ação do "Marcar Todos" (Atualizado) ---
    selectAllCheckbox.addEventListener('change', () => {
        const checkboxes = resultsBody.querySelectorAll('.asset-checkbox'); // <--- MUDOU
        checkboxes.forEach(cb => {
            cb.checked = selectAllCheckbox.checked;
        });
        updatePrintButtonState();
    });

    // --- 5. Ação do Botão Imprimir (Atualizado) ---
    printButton.addEventListener('click', () => {
        sendToPrintAPI();
    });

    async function sendToPrintAPI() {
        const selectedItems = [];
        // Busca checkboxes marcados dentro do <tbody>
        const checkedCheckboxes = resultsBody.querySelectorAll('.asset-checkbox:checked'); // <--- MUDOU

        checkedCheckboxes.forEach(cb => {
            const tr = cb.closest('tr'); // <--- MUDOU de 'li' para 'tr'
            selectedItems.push({
                titulo: tr.dataset.titulo, // Pega o dado do <tr>
                url: tr.dataset.url      // Pega o dado do <tr>
            });
        });

        if (selectedItems.length === 0) {
            alert('Selecione pelo menos um item para imprimir.');
            return;
        }

        printButton.disabled = true;
        printButton.innerText = 'Enviando...';
        printMessage.innerText = '';
        printMessage.className = '';

        try {
            const response = await fetch(printApiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(selectedItems)
            });
            const result = await response.json();

            if (response.ok) {
                printMessage.className = 'success';
                printMessage.innerText = `Sucesso! ${result.message || 'Itens enviados.'}`;
                checkedCheckboxes.forEach(cb => cb.checked = false);
                selectAllCheckbox.checked = false;
                updatePrintButtonState();
            } else {
                throw new Error(result.message || 'Erro desconhecido');
            }

        } catch (error) {
            printMessage.className = 'error';
            printMessage.innerText = `Erro ao imprimir: ${error.message}`;
        } finally {
            printButton.disabled = false;
            printButton.innerText = 'Imprimir Selecionados';
        }
    }

    // --- 6. Habilitar/Desabilitar Botão de Impressão (Atualizado) ---
    resultsBody.addEventListener('change', (event) => { // <--- MUDOU (ouve o <tbody>)
        if (event.target.classList.contains('asset-checkbox')) {
            updatePrintButtonState();
        }
    });

    function updatePrintButtonState() {
        const anyChecked = resultsBody.querySelector('.asset-checkbox:checked'); // <--- MUDOU
        printButton.disabled = !anyChecked;
    }
});
</script>
{% endblock %}