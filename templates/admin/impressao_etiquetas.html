{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
    /* Cores padrão do Admin */
    :root {
        /* AQUI ESTAVA O ERRO: 
        Estava '--module-lg' (errado)
        Agora é '--module-bg' (correto)
        */
        --custom-module-bg: var(--module-bg, #f0f0f0); 
        
        --custom-body-bg: var(--body-bg, #f9f9f9);
        --custom-border-color: var(--border-color, #ccc);
        --custom-error-fg: var(--error-fg, #ba2121);
        --custom-success-fg: var(--success-fg, #41763b);
    }

    .asset-filters button {
        margin-right: 5px;
        margin-bottom: 10px;
    }
    
    #results-list {
        list-style-type: none;
        padding-left: 0;
        max-height: 50vh;
        overflow-y: auto;
        border: 1px solid var(--custom-border-color);
        padding: 10px;
        background: var(--custom-body-bg);
        border-radius: 4px;
    }
    #results-list li {
        padding: 8px;
        border-bottom: 1px solid var(--custom-border-color);
    }
    #results-list li:last-child {
        border-bottom: none;
    }
    #results-list li input {
        margin-right: 10px;
    }
    #results-list li label {
        display: inline-block;
        cursor: pointer;
    }
    
    .controls-bar {
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 10px;
        /* Esta linha agora usará a variável correta */
        background: var(--custom-module-bg); 
        padding: 10px;
        border-radius: 4px;
    }
    
    .loader {
        display: none;
        /* Esta linha também usará a variável correta */
        border: 4px solid var(--custom-module-bg);
        border-radius: 50%;
        border-top: 4px solid var(--header-link-color, #3498db);
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
    }
    
    #print-message {
        margin-top: 10px;
        font-weight: bold;
    }
    #print-message.success {
        color: var(--custom-success-fg);
    }
    #print-message.error {
        color: var(--custom-error-fg);
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    </style>
{% endblock %}


{% block content %}
<h1>{{ title }}</h1>

<p>Selecione um tipo de ativo para carregar os itens. Em seguida, selecione os itens que deseja imprimir.</p>

<div class="asset-filters">
    {% for asset_value, asset_name in tipos_de_ativos_display %}
        <button class="button" data-type="{{ asset_value }}">
            {{ asset_name }}
        </button>
    {% endfor %}
</div>

<hr>

<div class="controls-bar">
  <button id="print-button" class="button" disabled>Imprimir Selecionados</button>
  
  <div class="loader" id="loader"></div>
  
  <div>
    <input type="checkbox" id="select-all" style="margin-right: 5px;">
    <label for="select-all">Marcar/Desmarcar Todos</label>
  </div>
</div>

<ul id="results-list">
  <li id="list-placeholder">Selecione um tipo de ativo acima.</li>
</ul>

<div id="print-message"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    const filterButtons = document.querySelectorAll('.asset-filters button');
    const resultsList = document.getElementById('results-list');
    const listPlaceholder = document.getElementById('list-placeholder');
    const printButton = document.getElementById('print-button');
    const selectAllCheckbox = document.getElementById('select-all');
    const loader = document.getElementById('loader');
    const printMessage = document.getElementById('print-message');

    // URLs
    const dataApiUrl = "/api/get-assets/";
    // Usa o caminho fixo para a API de impressão, como solicitado
    const printApiUrl = '/api/imprimir/'; 

    // --- Função para buscar o Token CSRF ---
    function getCsrfToken() {
        return document.cookie.split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
    }

    // --- 1. Ação dos Botões de Filtro ---
    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            const assetType = button.dataset.type;
            fetchAssets(assetType);
        });
    });

    async function fetchAssets(assetType) {
        resultsList.innerHTML = ''; // Limpa a lista
        printButton.disabled = true;
        selectAllCheckbox.checked = false;
        loader.style.display = 'block'; // Mostra o loader
        printMessage.innerText = '';
        if (listPlaceholder) listPlaceholder.remove();

        try {
            const response = await fetch(`${dataApiUrl}?type=${assetType}`);
            if (!response.ok) {
                throw new Error(`Erro na API: ${response.statusText}`);
            }
            const assets = await response.json(); // assets já vêm como [{"titulo": ..., "url": ...}]

            if (assets.length === 0) {
                resultsList.innerHTML = '<li>Nenhum item encontrado.</li>';
                return;
            }

            // Popula a lista com os resultados
            assets.forEach(asset => {
                const li = document.createElement('li');
                
                // Armazena os dados no próprio elemento (esta é a lista temporária)
                li.dataset.titulo = asset.titulo;
                li.dataset.url = asset.url;

                // Cria o checkbox e o label
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'asset-checkbox';
                checkbox.id = `asset-${asset.url}`; // ID único
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = asset.titulo;

                li.appendChild(checkbox);
                li.appendChild(label);
                resultsList.appendChild(li);
            });

        } catch (error) {
            resultsList.innerHTML = `<li>Erro ao carregar dados: ${error.message}</li>`;
            console.error(error);
        } finally {
            loader.style.display = 'none'; // Esconde o loader
        }
    }

    // --- 2. Ação do "Marcar Todos" ---
    selectAllCheckbox.addEventListener('change', () => {
        const checkboxes = resultsList.querySelectorAll('.asset-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = selectAllCheckbox.checked;
        });
        updatePrintButtonState();
    });

    // --- 3. Ação do Botão Imprimir ---
    printButton.addEventListener('click', () => {
        sendToPrintAPI();
    });

    async function sendToPrintAPI() {
        const selectedItems = [];
        // Busca somente os checkboxes marcados
        const checkedCheckboxes = resultsList.querySelectorAll('.asset-checkbox:checked');

        checkedCheckboxes.forEach(cb => {
            const li = cb.closest('li'); // Pega o <li> pai
            // Lê os dados armazenados no <li>
            selectedItems.push({
                titulo: li.dataset.titulo,
                url: li.dataset.url
            });
        });

        if (selectedItems.length === 0) {
            alert('Selecione pelo menos um item para imprimir.');
            return;
        }

        printButton.disabled = true;
        printButton.innerText = 'Enviando...';
        printMessage.innerText = '';

        try {
            const response = await fetch(printApiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken() // Essencial para o POST no Django
                },
                body: JSON.stringify(selectedItems) // Envia o JSON no formato exato
            });

            const result = await response.json();

            if (response.ok) {
                printMessage.style.color = 'green';
                printMessage.innerText = `Sucesso! ${result.message || 'Itens enviados.'}`;
                // Limpa a seleção
                checkedCheckboxes.forEach(cb => cb.checked = false);
                selectAllCheckbox.checked = false;
                updatePrintButtonState();
            } else {
                throw new Error(result.message || 'Erro desconhecido no endpoint de impressão');
            }

        } catch (error) {
            printMessage.style.color = 'red';
            printMessage.innerText = `Erro ao imprimir: ${error.message}`;
            console.error(error);
        } finally {
            printButton.disabled = false; // Reabilita o botão mesmo em caso de erro
            printButton.innerText = 'Imprimir Selecionados';
        }
    }

    // --- 4. Habilitar/Desabilitar Botão de Impressão ---
    // Ouve cliques na lista inteira (event delegation)
    resultsList.addEventListener('change', (event) => {
        if (event.target.classList.contains('asset-checkbox')) {
            updatePrintButtonState();
        }
    });

    function updatePrintButtonState() {
        const anyChecked = resultsList.querySelector('.asset-checkbox:checked');
        printButton.disabled = !anyChecked;
    }
});
</script>
{% endblock %}