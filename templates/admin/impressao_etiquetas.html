{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    /* Cores padrão do Admin */
    :root {
      --custom-module-bg: var(--body-bg, #f0f0f0);
      --custom-body-bg: var(--body-bg, #f9f9f9);
      --custom-border-color: var(--border-color, #ccc);
      --custom-error-fg: var(--error-fg, #ba2121);
      --custom-success-fg: var(--success-fg, #41763b);
      --custom-header-link-color: var(--header-link-color, #3498db);
    }
  
    .asset-filters button {
      margin-right: 5px;
      margin-bottom: 10px;
      
      opacity: 0.7;
      border-width: 2px;
      border-color: transparent; 
      transition: opacity 0.2s ease, border-color 0.2s ease;
    }

    .asset-filters button.active {
      opacity: 1;
      border-color: var(--custom-header-link-color); 
    }
    
    .controls-bar {
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 10px;
      background: var(--custom-module-bg); 
      padding: 10px;
      border-radius: 4px;
      gap: 15px;
    }

    .search-wrapper {
      flex-grow: 1;
      text-align: center;
    }

    #search-input {
      width: 60%;
      padding: 8px 10px;
      border: 1px solid var(--custom-border-color);
      border-radius: 4px;
      background-color: var(--custom-body-bg); 
      color: var(--body-fg); 
      box-sizing: border-box;
    }
    
    .table-container {
      max-height: 50vh;
      overflow-y: auto;
      border: 1px solid var(--custom-border-color);
      border-radius: 4px;
      background: var(--custom-body-bg);
    }
    
    #results-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    #results-table th, #results-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--custom-border-color);
    }
    
    #results-table th {
      background: var(--custom-module-bg);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    
    #results-table th[data-key] {
      cursor: pointer;
      user-select: none;
    }

    #results-table th[data-key]::after {
      content: ' \25B2\25BC';
      color: var(--custom-border-color);
      opacity: 0.5;
    }
    #results-table th[data-sort-dir="asc"]::after {
      content: ' \25B2';
      opacity: 1;
      color: var(--custom-header-link-color);
    }
    #results-table th[data-sort-dir="desc"]::after {
      content: ' \25BC';
      opacity: 1;
      color: var(--custom-header-link-color);
    }
    
    .loader {
      display: none;
      border: 4px solid var(--custom-module-bg);
      border-radius: 50%;
      border-top: 4px solid var(--custom-header-link-color);
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    
    #print-message {
      margin-top: 10px;
      font-weight: bold;
    }
    #print-message.success { color: var(--custom-success-fg); }
    #print-message.error { color: var(--custom-error-fg); }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
{% endblock %}

{% block content %}

<p>Selecione um tipo de ativo para carregar os itens. Em seguida, selecione os itens que deseja imprimir.</p>

<div class="asset-filters">
  {% for asset_value, asset_name in tipos_de_ativos_display %}
    <button class="button" data-type="{{ asset_value }}">
      {{ asset_name }}
    </button>
  {% endfor %}
</div>

<hr>

<div class="controls-bar">
  <button id="print-button" class="button" disabled>Imprimir Selecionados</button>
  
  <div class="search-wrapper">
    <input type="search" id="search-input" placeholder="Filtrar por nome do ativo...">
  </div>
  
  <div class="loader" id="loader"></div>
  
  <div>
    <input type="checkbox" id="select-all" style="margin-right: 5px;">
    <label for="select-all">Marcar/Desmarcar Todos</label>
  </div>
</div>
<div class="table-container">
  <table id="results-table">
    <thead>
      <tr>
        <th style="width: 20px;"></th>
        <th data-key="asset_name">Nome do Ativo</th>
        <th data-key="entity">Entidade</th>
        <th data-key="asset_type">Tipo</th>
      </tr>
    </thead>
    <tbody id="results-body">
      <tr>
        <td colspan="4" style="text-align: center; padding: 20px;">
          Selecione um tipo de ativo acima.
        </td>
      </tr>
    </tbody>
  </table>
</div>

<div id="print-message"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // --- Referências aos elementos ---
    const filterButtons = document.querySelectorAll('.asset-filters button');
    const printButton = document.getElementById('print-button');
    const selectAllCheckbox = document.getElementById('select-all');
    const loader = document.getElementById('loader');
    const printMessage = document.getElementById('print-message');
    const resultsBody = document.getElementById('results-body');
    const headers = document.querySelectorAll('#results-table th[data-key]');
    
    // ---- NOVO: Referência ao campo de pesquisa ----
    const searchInput = document.getElementById('search-input');

    // --- URLs ---
    const dataApiUrl = "/api/get-assets/";
    const printApiUrl = '/api/imprimir/'; 

    // --- Variáveis de Estado ---
    let fetchedAssets = []; // Armazena os dados brutos da API
    let currentSort = { key: 'asset_name', dir: 'asc' };

    // --- Função para buscar o Token CSRF ---
    function getCsrfToken() {
        return document.cookie.split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
    }

    // --- 1. Ação dos Botões de Filtro ---
    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            
            // 1. Remove a classe 'active' de TODOS os botões
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // 2. Adiciona a classe 'active' apenas ao botão que foi clicado
            button.classList.add('active');
            // ---- FIM DA MUDANÇA ----

            const assetType = button.dataset.type;
            fetchAssets(assetType);
        });
    });

    async function fetchAssets(assetType) {
        resultsBody.innerHTML = ''; 
        printButton.disabled = true;
        selectAllCheckbox.checked = false;
        loader.style.display = 'block';
        printMessage.innerText = '';
        
        // ---- NOVO: Limpa o campo de pesquisa ao trocar de tipo ----
        searchInput.value = ''; 
        
        fetchedAssets = []; // Limpa dados antigos

        try {
            const response = await fetch(`${dataApiUrl}?type=${assetType}`);
            if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);
            
            const assets = await response.json();
            fetchedAssets = assets; // Salva os dados brutos
            
            applyFiltersAndSort(); 

        } catch (error) {
            fetchedAssets = []; // Garante que a lista esteja vazia
            applyFiltersAndSort(); // Renderiza a mensagem de erro/vazio
            console.error(error);
        } finally {
            loader.style.display = 'none';
        }
    }

    // --- 2. Lógica de Ordenação (Evento de clique) ---
    headers.forEach(header => {
        header.addEventListener('click', () => {
            const key = header.dataset.key;
            let newDir = 'asc';
            
            if (currentSort.key === key && currentSort.dir === 'asc') {
                newDir = 'desc';
            }
            
            currentSort = { key: key, dir: newDir };
            applyFiltersAndSort(); // Re-filtra, re-ordena e re-renderiza
        });
    });

    // --- 3. NOVO: Lógica de Filtro (Evento de digitação) ---
    searchInput.addEventListener('input', () => {
        // A cada tecla digitada, re-filtra, re-ordena e re-renderiza
        applyFiltersAndSort();
    });

    // --- 4. NOVO: Função Central de Filtro, Ordenação e Renderização ---
    function applyFiltersAndSort() {
        
        // --- ETAPA DE FILTRO ---
        const searchTerm = searchInput.value.toLowerCase();
        let processedAssets = fetchedAssets;

        if (searchTerm) {
            processedAssets = fetchedAssets.filter(asset => {
                // Filtra pelo nome do ativo (asset_name)
                return asset.asset_name.toLowerCase().includes(searchTerm);
            });
        }

        // --- ETAPA DE ORDENAÇÃO ---
        const { key, dir } = currentSort;
        
        const sortedAssets = [...processedAssets].sort((a, b) => {
            let valA = a[key] ? a[key].toString().toLowerCase() : '';
            let valB = b[key] ? b[key].toString().toLowerCase() : '';

            // Tenta ordenar numericamente
            const numA = parseFloat(valA);
            const numB = parseFloat(valB);
            
            if (!isNaN(numA) && !isNaN(numB)) {
                valA = numA;
                valB = numB;
            }

            if (valA < valB) return dir === 'asc' ? -1 : 1;
            if (valA > valB) return dir === 'asc' ? 1 : -1;
            return 0;
        });

        // Atualiza os indicadores visuais nos cabeçalhos
        headers.forEach(h => {
            if (h.dataset.key === key) h.dataset.sortDir = dir;
            else h.dataset.sortDir = '';
        });

        // --- ETAPA DE RENDERIZAÇÃO ---
        renderTable(sortedAssets); // Renderiza a lista final
    }

    // --- 5. Lógica de Renderização da Tabela (Atualizada) ---
    // (A antiga 'sortAndRender' foi dividida)
    function renderTable(assetsToRender) {
        resultsBody.innerHTML = ''; // Limpa a tabela
        
        // ---- Lógica de "Nenhum resultado" melhorada ----
        if (assetsToRender.length === 0) {
            const searchTerm = searchInput.value;
            if (searchTerm) {
                // Caso 1: Filtrou e não achou nada
                resultsBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 20px;">Nenhum item corresponde ao filtro "<b>${searchTerm}</b>".</td></tr>`;
            } else if (fetchedAssets.length > 0) {
                 // Caso 2: Deveria ter itens, mas o filtro limpou (nunca deve acontecer, mas é seguro)
                 resultsBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 20px;">Nenhum item corresponde ao filtro.</td></tr>`;
            } else {
                // Caso 3: A API não retornou nada
                resultsBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 20px;">Nenhum item encontrado para este tipo de ativo.</td></tr>`;
            }
            return; // Para a execução
        }
        
        // Constrói as linhas da tabela
        assetsToRender.forEach(asset => {
            const tr = document.createElement('tr');
            
            tr.dataset.titulo = asset.asset_name; 
            tr.dataset.url = asset.url;

            // Coluna 1: Checkbox
            const tdCheck = document.createElement('td');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'asset-checkbox';
            tdCheck.appendChild(checkbox);
            tr.appendChild(tdCheck);

            // Coluna 2: Nome do Ativo
            const tdName = document.createElement('td');
            tdName.textContent = asset.asset_name;
            tr.appendChild(tdName);

            // Coluna 3: Entidade
            const tdEntity = document.createElement('td');
            tdEntity.textContent = asset.entity;
            tr.appendChild(tdEntity);

            // Coluna 4: Tipo de Ativo
            const tdType = document.createElement('td');
            tdType.textContent = asset.asset_type;
            tr.appendChild(tdType);

            resultsBody.appendChild(tr);
        });
    }

    // --- 6. Ação do "Marcar Todos" (Sem mudança) ---
    selectAllCheckbox.addEventListener('change', () => {
        const checkboxes = resultsBody.querySelectorAll('.asset-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = selectAllCheckbox.checked;
        });
        updatePrintButtonState();
    });

    // --- 7. Ação do Botão Imprimir (Sem mudança) ---
    printButton.addEventListener('click', () => {
        sendToPrintAPI();
    });

    async function sendToPrintAPI() {
        const selectedItems = [];
        const checkedCheckboxes = resultsBody.querySelectorAll('.asset-checkbox:checked');

        checkedCheckboxes.forEach(cb => {
            const tr = cb.closest('tr');
            selectedItems.push({
                titulo: tr.dataset.titulo,
                url: tr.dataset.url
            });
        });

        if (selectedItems.length === 0) {
            alert('Selecione pelo menos um item para imprimir.');
            return;
        }

        printButton.disabled = true;
        printButton.innerText = 'Enviando...';
        printMessage.innerText = '';
        printMessage.className = '';

        try {
            const response = await fetch(printApiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(selectedItems)
            });
            const result = await response.json();

            if (response.ok) {
                printMessage.className = 'success';
                printMessage.innerText = `Sucesso! ${result.mensagem || 'Itens enviados.'}`;
                checkedCheckboxes.forEach(cb => cb.checked = false);
                selectAllCheckbox.checked = false;
                updatePrintButtonState();
            } else {
                throw new Error(result.mensagem || 'Erro desconhecido no endpoint de impressão');
            }

        } catch (error) {
            printMessage.className = 'error';
            printMessage.innerText = `Erro ao imprimir: ${error.message}`;
        } finally {
            printButton.disabled = false;
            printButton.innerText = 'Imprimir Selecionados';
        }
    }

    // --- 8. Habilitar/Desabilitar Botão de Impressão (Sem mudança) ---
    resultsBody.addEventListener('change', (event) => {
        if (event.target.classList.contains('asset-checkbox')) {
            updatePrintButtonState();
        }
    });

    function updatePrintButtonState() {
        const anyChecked = resultsBody.querySelector('.asset-checkbox:checked');
        printButton.disabled = !anyChecked;
    }
});
</script>
{% endblock %}